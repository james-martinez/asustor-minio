name: Build Asustor Package

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Nginx (ARM64)
        run: |
          cd asustor-minio
          # Build for ARM64 and export the binary
          docker buildx build --platform linux/arm64 --output type=local,dest=. -f Dockerfile.nginx .
          # The binary will be in ./nginx (from the COPY instruction in Dockerfile)
          mv nginx nginx_bin

      - name: Build Package
        run: |
          cd asustor-minio
          # The script will look for 'nginx_bin' and use it
          python build_minio_apk.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: minio-asustor-apk
          path: "*.apk"
          if-no-files-found: error